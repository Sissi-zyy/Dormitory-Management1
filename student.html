<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>宿舍管理系统 - 住宿学生</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap">
  <link rel="stylesheet" href="style.css">

  <!-- 添加模态框样式 -->
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Noto Sans SC', sans-serif;
      background-color: #f5f7fa;
      color: #333;
      line-height: 1.6;
    }

    .container {
      display: flex;
      min-height: 100vh;
    }

    /* 侧边栏样式 */
    .sidebar {
      width: 240px;
      background: linear-gradient(180deg, #1e3c72 0%, #2a5298 100%);
      color: white;
      padding: 20px 0;
      box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
      z-index: 100;
    }

    .logo-area {
      padding: 0 20px 30px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .logo {
      display: flex;
      align-items: center;
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 10px;
    }

    .logo i {
      margin-right: 12px;
      font-size: 24px;
    }

    .campus-info {
      font-size: 12px;
      opacity: 0.8;
      padding-left: 36px;
    }

    .nav-links {
      list-style: none;
      padding: 20px 0;
    }

    .nav-links li {
      margin: 5px 0;
    }

    .nav-links a {
      display: flex;
      align-items: center;
      padding: 12px 20px;
      color: rgba(255, 255, 255, 0.8);
      text-decoration: none;
      transition: all 0.3s;
      border-left: 4px solid transparent;
    }

    .nav-links a:hover,
    .nav-links a.active {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border-left-color: #4CAF50;
    }

    .nav-links i {
      width: 24px;
      margin-right: 12px;
      font-size: 16px;
    }

    /* 主要内容区域 */
    .main-content {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
    }

    /* 头部样式 */
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid #e0e6ef;
    }

    .header-title h1 {
      font-size: 28px;
      color: #2c3e50;
      margin-bottom: 5px;
    }

    .header-title p {
      color: #7f8c8d;
      font-size: 14px;
    }

    .header-controls {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .search-bar {
      position: relative;
      background: white;
      border-radius: 25px;
      padding: 8px 15px 8px 40px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      border: 1px solid #e0e6ef;
    }

    .search-bar i {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: #95a5a6;
    }

    .search-bar input {
      border: none;
      outline: none;
      width: 200px;
      background: transparent;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    /* 模态框样式 */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background-color: white;
      border-radius: 10px;
      width: 800px;
      max-width: 95%;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      animation: modalFadeIn 0.3s;
      max-height: 90vh;
      overflow-y: auto;
    }

    @keyframes modalFadeIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .modal-header {
      padding: 20px;
      background: linear-gradient(180deg, #1e40af 0%, #1e3a8a 100%);
      color: white;
      border-radius: 10px 10px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    .modal-header h3 {
      margin: 0;
      font-size: 18px;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: white;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .close-btn:hover {
      background-color: rgba(255, 255, 255, 0.1);
      border-radius: 50%;
    }

    .modal-body {
      padding: 30px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #555;
      font-size: 14px;
    }

    .form-control {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      font-family: 'Noto Sans SC', sans-serif;
      transition: border-color 0.3s;
    }

    .form-control:focus {
      border-color: #2a5bd7;
      outline: none;
      box-shadow: 0 0 0 3px rgba(42, 91, 215, 0.1);
    }

    .form-row {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
    }

    .form-row .form-group {
      flex: 1;
      margin-bottom: 0;
    }

    .modal-footer {
      padding: 20px;
      border-top: 1px solid #eee;
      text-align: right;
      position: sticky;
      bottom: 0;
      background: white;
    }

    .modal-footer .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s;
      margin-left: 10px;
    }

    .modal-footer .btn-secondary {
      background-color: #f5f5f5;
      color: #666;
    }

    .modal-footer .btn-secondary:hover {
      background-color: #e0e0e0;
    }

    .modal-footer .btn-primary {
      background-color: #2a5bd7;
      color: white;
    }

    .modal-footer .btn-primary:hover {
      background-color: #1a3a8f;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(26, 58, 143, 0.3);
    }

    /* 宿舍楼性别标签 */
    .gender-tag {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 5px;
      vertical-align: middle;
    }

    .male-tag {
      background-color: #e3f2fd;
      color: #1976d2;
    }

    .female-tag {
      background-color: #fce4ec;
      color: #c2185b;
    }

    /* 搜索框样式增强 */
    .search-bar {
      position: relative;
      width: 300px;
    }

    .search-bar i {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #666;
    }

    .search-bar input {
      width: 100%;
      padding: 10px 10px 10px 40px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      transition: all 0.3s;
    }

    .search-bar input:focus {
      border-color: #2a5bd7;
      outline: none;
      box-shadow: 0 0 0 3px rgba(42, 91, 215, 0.1);
    }

    /* 导出选项样式 */
    .export-options {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
    }

    .export-option {
      flex: 1;
      padding: 15px;
      border: 2px solid #e1e5eb;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
    }

    .export-option:hover {
      border-color: #2a5bd7;
      background-color: #f8fafd;
    }

    .export-option.selected {
      border-color: #2a5bd7;
      background-color: #e8f0ff;
    }

    .export-option i {
      font-size: 24px;
      color: #2a5bd7;
      margin-bottom: 10px;
      display: block;
    }

    .export-option h4 {
      margin: 0 0 5px 0;
      color: #333;
    }

    .export-option p {
      margin: 0;
      color: #666;
      font-size: 12px;
    }

    /* 批量导入样式 */
    .import-area {
      border: 2px dashed #ddd;
      border-radius: 8px;
      padding: 40px;
      text-align: center;
      margin: 20px 0;
      cursor: pointer;
      transition: all 0.3s;
    }

    .import-area:hover {
      border-color: #2a5bd7;
      background-color: #f8fafd;
    }

    .import-area i {
      font-size: 48px;
      color: #2a5bd7;
      margin-bottom: 15px;
    }

    .import-area p {
      color: #666;
      margin: 10px 0;
    }

    .import-file-list {
      margin-top: 20px;
    }

    .file-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px;
      background-color: #f8fafd;
      border-radius: 6px;
      margin-bottom: 10px;
    }

    .file-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .file-info i {
      color: #4cd964;
    }

    /* 搜索提示 */
    .search-hint {
      margin-top: 5px;
      font-size: 12px;
      color: #666;
      display: none;
    }

    .search-results-count {
      margin: 15px 0;
      color: #666;
      font-size: 14px;
      padding: 10px 15px;
      background-color: #f8fafd;
      border-radius: 6px;
      border-left: 4px solid #2a5bd7;
    }

    .no-results {
      text-align: center;
      padding: 40px 20px;
      color: #666;
    }

    .no-results i {
      font-size: 48px;
      margin-bottom: 15px;
      color: #ddd;
    }

    /* 导出进度条 */
    .export-progress {
      width: 100%;
      height: 4px;
      background-color: #e1e5eb;
      border-radius: 2px;
      margin: 20px 0;
      overflow: hidden;
      display: none;
    }

    .export-progress-bar {
      height: 100%;
      background-color: #4cd964;
      width: 0%;
      transition: width 0.3s;
    }

    /* 学生详情样式 */
    .student-detail-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .detail-section {
      background: #f8fafd;
      border-radius: 8px;
      padding: 20px;
      border: 1px solid #e1e5eb;
    }

    .detail-section h4 {
      margin-top: 0;
      color: #2a5bd7;
      font-size: 16px;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #e1e5eb;
    }

    .detail-item {
      margin-bottom: 10px;
      display: flex;
    }

    .detail-label {
      font-weight: 600;
      color: #555;
      min-width: 100px;
    }

    .detail-value {
      color: #333;
      flex: 1;
    }

    /* 学院标签 */
    .college-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .college-1 {
      background-color: #e3f2fd;
      color: #1976d2;
    }

    .college-2 {
      background-color: #f3e5f5;
      color: #7b1fa2;
    }

    .college-3 {
      background-color: #e8f5e9;
      color: #388e3c;
    }

    .college-4 {
      background-color: #fff3e0;
      color: #f57c00;
    }

    .college-5 {
      background-color: #fce4ec;
      color: #c2185b;
    }

    /* 响应式调整 */
    @media (max-width: 768px) {
      .search-bar {
        width: 100%;
        margin-bottom: 15px;
      }

      .export-options {
        flex-direction: column;
      }

      .form-row {
        flex-direction: column;
        gap: 0;
      }

      .modal-content {
        width: 95%;
      }

      .student-detail-grid {
        grid-template-columns: 1fr;
      }
    }

    /* 统计卡片样式 */
    .dashboard-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .card {
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
      border: 1px solid #e1e5eb;
      transition: transform 0.3s;
    }

    .card:hover {
      transform: translateY(-5px);
    }

    .card-header {
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .card-title {
      margin: 0;
      font-size: 16px;
      color: #333;
    }

    .card-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      color: white;
    }

    .card-1 .card-icon {
      background: linear-gradient(135deg, #2a5bd7 0%, #1a3a8f 100%);
    }

    .card-2 .card-icon {
      background: linear-gradient(135deg, #ff6b6b 0%, #c2185b 100%);
    }

    .card-3 .card-icon {
      background: linear-gradient(135deg, #4cd964 0%, #388e3c 100%);
    }

    .card-4 .card-icon {
      background: linear-gradient(135deg, #ffb74d 0%, #f57c00 100%);
    }

    .card-body {
      padding: 15px 20px;
    }

    .card-body h2 {
      margin: 0 0 10px 0;
      font-size: 28px;
      color: #2a5bd7;
    }

    .card-body p {
      margin: 0;
      color: #666;
      font-size: 13px;
    }

    /* 床位占用状态 */
    .bed-status {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 5px;
    }

    .bed-occupied {
      background-color: #ffebee;
      color: #d32f2f;
    }

    .bed-available {
      background-color: #e8f5e9;
      color: #388e3c;
    }

    /* 调换宿舍模态框 */
    .room-options {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #e1e5eb;
      border-radius: 6px;
      padding: 10px;
    }

    .room-option {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .room-option:hover {
      border-color: #2a5bd7;
      background-color: #f8fafd;
    }

    .room-option.selected {
      border-color: #2a5bd7;
      background-color: #e8f0ff;
    }

    .room-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .room-gender {
      font-size: 12px;
      color: #666;
    }
  </style>
</head>

<body>
  <div class="container">
    <aside class="sidebar">
      <div class="logo-area">
        <div class="logo">
          <i class="fas fa-hotel"></i>
          <span>宿舍管理系统</span>
        </div>
        <div class="campus-info">四川工商学院学生宿舍管理中心</div>
      </div>
      <ul class="nav-links">
        <li><a href="index.html"><i class="fas fa-home"></i><span>系统首页</span></a></li>
        <li><a href="dorm-management.html"><i class="fas fa-building"></i><span>宿舍楼管理</span></a></li>
        <li><a href="student.html" class="active"><i class="fas fa-user-friends"></i><span>住宿学生</span></a></li>
        <li><a href="bed-assignment.html"><i class="fas fa-bed"></i><span>床位分配</span></a></li>
        <li><a href="repair.html"><i class="fas fa-tools"></i><span>报修管理</span></a></li>
        <li><a href="visitor.html"><i class="fas fa-user-check"></i><span>访客登记</span></a></li>
        <li><a href="statistics.html"><i class="fas fa-chart-bar"></i><span>数据统计</span></a></li>
        <li><a href="settings.html"><i class="fas fa-cog"></i><span>系统设置</span></a></li>
      </ul>
    </aside>

    <main class="main-content">
      <header>
        <div class="header-title">
          <h1>住宿学生管理</h1>
          <p>查看和管理所有住宿学生信息</p>
        </div>
        <div class="header-controls">
          <div class="search-bar">
            <i class="fas fa-search"></i>
            <input type="text" placeholder="搜索学生..." id="searchInput">
            <div class="search-hint" id="searchHint">支持按学号、姓名、学院、专业搜索</div>
          </div>
          <div class="user-info">
            <div class="user-avatar">
              <i class="fas fa-user-tie"></i>
            </div>
            <div class="user-details">
              <h3>李管理员</h3>
              <p>宿舍管理中心</p>
            </div>
          </div>
        </div>
      </header>

      <div class="action-buttons" style="margin-bottom: 20px;">
        <button class="btn btn-primary" id="addStudentBtn">
          <i class="fas fa-user-plus"></i> 添加学生
        </button>
        <button class="btn btn-success" id="importStudentBtn">
          <i class="fas fa-upload"></i> 批量导入
        </button>
        <button class="btn btn-warning" id="exportStudentBtn">
          <i class="fas fa-download"></i> 导出数据
        </button>
      </div>

      <div class="feature-card">
        <h2 class="feature-title"><i class="fas fa-users"></i> 住宿学生列表</h2>
        <div class="search-results-count" id="resultsCount"></div>
        <table class="data-table" id="studentTable">
          <thead>
            <tr>
              <th>学号</th>
              <th>姓名</th>
              <th>学院</th>
              <th>专业</th>
              <th>宿舍楼</th>
              <th>房间号</th>
              <th>床位号</th>
              <th>入住时间</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody id="studentTableBody">
            <!-- 数据将通过JavaScript动态生成 -->
          </tbody>
        </table>
        <div class="no-results" id="noResults" style="display: none;">
          <i class="fas fa-search"></i>
          <h3>未找到匹配的学生</h3>
          <p>请尝试其他搜索关键词</p>
        </div>
      </div>

      <!-- 学生详情区域 -->
      <div class="feature-card" id="studentDetail" style="display: none;">
        <h2 class="feature-title"><i class="fas fa-user-graduate"></i> <span id="detailTitle">学生详情</span>
          <button class="btn btn-sm btn-secondary" onclick="closeDetail()" style="float: right; margin-top: -5px;">
            <i class="fas fa-times"></i> 关闭
          </button>
        </h2>
        <div id="detailContent">
          <!-- 详情内容将通过JavaScript动态生成 -->
        </div>
      </div>

      <!-- 统计信息区域 -->
      <div class="feature-card">
        <h2 class="feature-title"><i class="fas fa-chart-bar"></i> 学生统计信息</h2>
        <div class="dashboard-cards">
          <div class="card card-1">
            <div class="card-header">
              <h3 class="card-title">住宿学生总数</h3>
              <div class="card-icon">
                <i class="fas fa-users"></i>
              </div>
            </div>
            <div class="card-body">
              <h2 id="totalStudents">0</h2>
              <p id="studentGrowth">较上月增长 0%</p>
            </div>
          </div>

          <div class="card card-2">
            <div class="card-header">
              <h3 class="card-title">按性别分布</h3>
              <div class="card-icon">
                <i class="fas fa-venus-mars"></i>
              </div>
            </div>
            <div class="card-body">
              <h2 id="genderRatio">0 | 0</h2>
              <p id="genderPercent">男生: 0% | 女生: 0%</p>
            </div>
          </div>

          <div class="card card-3">
            <div class="card-header">
              <h3 class="card-title">按学院分布</h3>
              <div class="card-icon">
                <i class="fas fa-university"></i>
              </div>
            </div>
            <div class="card-body">
              <h2 id="collegeCount">0</h2>
              <p id="topCollege">计算机学院人数最多: 0人</p>
            </div>
          </div>

          <div class="card card-4">
            <div class="card-header">
              <h3 class="card-title">本月新增</h3>
              <div class="card-icon">
                <i class="fas fa-user-plus"></i>
              </div>
            </div>
            <div class="card-body">
              <h2 id="newStudents">0</h2>
              <p id="newBreakdown">其中: 新生 0人 | 调宿 0人</p>
            </div>
          </div>
        </div>
      </div>

      <footer class="footer">
        <p>© 2023 四川工商学院宿舍管理中心. 版权所有. 系统版本: 2.1.0</p>
      </footer>
    </main>
  </div>

  <!-- 添加学生模态框 -->
  <div class="modal-overlay" id="addStudentModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle">添加学生</h3>
        <button class="close-btn" id="closeModalBtn">&times;</button>
      </div>
      <form id="studentForm">
        <div class="modal-body">
          <div class="form-row">
            <div class="form-group">
              <label for="studentId">学号 *</label>
              <input type="text" id="studentId" class="form-control" placeholder="例如：2023001" required>
            </div>

            <div class="form-group">
              <label for="studentName">姓名 *</label>
              <input type="text" id="studentName" class="form-control" placeholder="例如：张三" required>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="gender">性别 *</label>
              <select id="gender" class="form-control" required onchange="updateDormBuildingOptions()">
                <option value="">请选择性别</option>
                <option value="男">男</option>
                <option value="女">女</option>
              </select>
            </div>

            <div class="form-group">
              <label for="college">学院 *</label>
              <select id="college" class="form-control" required>
                <option value="">请选择学院</option>
                <option value="计算机学院">计算机学院</option>
                <option value="外国语学院">外国语学院</option>
                <option value="机械工程学院">机械工程学院</option>
                <option value="医学院">医学院</option>
                <option value="经济学院">经济学院</option>
                <option value="文学院">文学院</option>
                <option value="法学院">法学院</option>
                <option value="艺术学院">艺术学院</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="major">专业 *</label>
              <input type="text" id="major" class="form-control" placeholder="例如：计算机科学与技术" required>
            </div>

            <div class="form-group">
              <label for="phone">联系电话</label>
              <input type="tel" id="phone" class="form-control" placeholder="例如：13800138000">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="dormBuilding">宿舍楼 *</label>
              <select id="dormBuilding" class="form-control" required onchange="checkAvailableRooms()">
                <option value="">请选择宿舍楼</option>
                <!-- 选项将通过JavaScript动态生成 -->
              </select>
            </div>

            <div class="form-group">
              <label for="roomNumber">房间号 *</label>
              <input type="text" id="roomNumber" class="form-control" placeholder="例如：408" required
                oninput="checkBedAvailability()">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="bedNumber">床位号 *</label>
              <select id="bedNumber" class="form-control" required>
                <option value="">请选择床位号</option>
                <option value="1号床">1号床</option>
                <option value="2号床">2号床</option>
                <option value="3号床">3号床</option>
                <option value="4号床">4号床</option>
              </select>
            </div>

            <div class="form-group">
              <label for="checkinDate">入住时间 *</label>
              <input type="date" id="checkinDate" class="form-control" required>
            </div>
          </div>

          <div class="form-group">
            <label for="studentDesc">备注信息</label>
            <textarea id="studentDesc" class="form-control" rows="3" placeholder="可填写学生的附加信息..."></textarea>
          </div>

          <div id="validationMessage"
            style="display: none; padding: 10px; background-color: #ffebee; color: #d32f2f; border-radius: 6px; margin-top: 10px;">
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" id="cancelBtn">取消</button>
          <button type="submit" class="btn btn-primary" id="submitBtn">确认添加</button>
        </div>
      </form>
    </div>
  </div>

  <!-- 批量导入模态框 -->
  <div class="modal-overlay" id="importModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>批量导入学生</h3>
        <button class="close-btn" id="closeImportBtn">&times;</button>
      </div>
      <div class="modal-body">
        <div class="import-area" id="importArea">
          <i class="fas fa-cloud-upload-alt"></i>
          <h4>点击上传或拖拽文件到此处</h4>
          <p>支持 Excel (.xlsx, .xls) 或 CSV (.csv) 格式</p>
          <p style="font-size: 12px; color: #999;">文件大小不超过 10MB</p>
          <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" style="display: none;">
        </div>

        <div class="import-file-list" id="fileList" style="display: none;">
          <!-- 上传的文件列表 -->
        </div>

        <div class="import-progress" id="importProgress" style="display: none;">
          <h4>导入进度</h4>
          <div class="export-progress">
            <div class="export-progress-bar" id="importProgressBar"></div>
          </div>
          <p id="importStatus">正在处理文件...</p>
        </div>

        <h4 style="margin-top: 30px;">导入模板说明</h4>
        <div class="form-group">
          <p style="color: #666; font-size: 14px; margin-bottom: 10px;">请按照以下格式准备Excel文件：</p>
          <div style="background-color: #f8fafd; padding: 15px; border-radius: 6px; font-size: 12px;">
            <p><strong>列顺序：</strong>学号, 姓名, 性别, 学院, 专业, 宿舍楼, 房间号, 床位号, 联系电话, 入住时间, 备注</p>
            <p><strong>示例：</strong>2023001, 张明, 男, 计算机学院, 计算机科学与技术, 3号楼, 408, 2号床, 13800138000, 2023-09-01, 无</p>
            <p><strong>注意：</strong>男生只能选择男生宿舍楼（1号楼、3号楼、5号楼），女生只能选择女生宿舍楼（2号楼、4号楼、6号楼）</p>
          </div>
          <button type="button" class="btn btn-outline" style="margin-top: 15px;" onclick="downloadTemplate()">
            <i class="fas fa-download"></i> 下载导入模板
          </button>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" id="cancelImportBtn">取消</button>
        <button type="button" class="btn btn-primary" id="startImportBtn" disabled>开始导入</button>
      </div>
    </div>
  </div>

  <!-- 导出数据模态框 -->
  <div class="modal-overlay" id="exportModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>导出学生数据</h3>
        <button class="close-btn" id="closeExportBtn">&times;</button>
      </div>
      <div class="modal-body">
        <h4>选择导出格式</h4>
        <div class="export-options">
          <div class="export-option selected" data-format="excel">
            <i class="fas fa-file-excel"></i>
            <h4>Excel 文件</h4>
            <p>.xlsx格式，适用于数据分析</p>
          </div>
          <div class="export-option" data-format="csv">
            <i class="fas fa-file-csv"></i>
            <h4>CSV 文件</h4>
            <p>.csv格式，通用数据格式</p>
          </div>
          <div class="export-option" data-format="pdf">
            <i class="fas fa-file-pdf"></i>
            <h4>PDF 文件</h4>
            <p>.pdf格式，适合打印和存档</p>
          </div>
        </div>

        <h4 style="margin-top: 30px;">导出范围</h4>
        <div class="form-group">
          <div class="form-row">
            <div class="form-group">
              <label>
                <input type="radio" name="exportRange" value="all" checked> 全部数据
              </label>
            </div>
            <div class="form-group">
              <label>
                <input type="radio" name="exportRange" value="current"> 当前搜索结果
              </label>
            </div>
            <div class="form-group">
              <label>
                <input type="radio" name="exportRange" value="selected"> 选中学院
                <select id="exportCollege" style="margin-left: 10px; padding: 5px;">
                  <option value="计算机学院">计算机学院</option>
                  <option value="外国语学院">外国语学院</option>
                  <option value="机械工程学院">机械工程学院</option>
                  <option value="医学院">医学院</option>
                  <option value="经济学院">经济学院</option>
                </select>
              </label>
            </div>
          </div>
        </div>

        <div class="export-progress" id="exportProgress">
          <div class="export-progress-bar" id="exportProgressBar"></div>
        </div>

        <div class="form-group">
          <label for="exportFileName">文件名</label>
          <input type="text" id="exportFileName" class="form-control" value="住宿学生数据_2023" placeholder="输入文件名">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" id="cancelExportBtn">取消</button>
        <button type="button" class="btn btn-primary" id="confirmExportBtn">开始导出</button>
      </div>
    </div>
  </div>

  <!-- 调换宿舍模态框 -->
  <div class="modal-overlay" id="changeRoomModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>调换宿舍</h3>
        <button class="close-btn" id="closeChangeRoomBtn">&times;</button>
      </div>
      <div class="modal-body">
        <div id="currentStudentInfo" style="margin-bottom: 20px;"></div>

        <div class="form-group">
          <label for="newDormBuilding">新宿舍楼 *</label>
          <select id="newDormBuilding" class="form-control" required onchange="loadAvailableRooms()">
            <option value="">请选择宿舍楼</option>
            <!-- 选项将通过JavaScript动态生成 -->
          </select>
        </div>

        <div class="form-group">
          <label>可选的房间</label>
          <div class="room-options" id="roomOptions">
            <!-- 房间选项将通过JavaScript动态生成 -->
          </div>
        </div>

        <div class="form-group" id="bedSelection" style="display: none;">
          <label for="newBedNumber">选择床位 *</label>
          <select id="newBedNumber" class="form-control" required>
            <option value="">请选择床位号</option>
          </select>
        </div>

        <div id="changeRoomMessage"
          style="display: none; padding: 10px; background-color: #ffebee; color: #d32f2f; border-radius: 6px; margin-top: 10px;">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" id="cancelChangeRoomBtn">取消</button>
        <button type="button" class="btn btn-primary" id="confirmChangeRoomBtn">确认调换</button>
      </div>
    </div>
  </div>

  <script src="js/common.js"></script>
  <script>
    // 学生数据
    const studentData = [
      {
        id: "2023001",
        name: "张明",
        gender: "男",
        college: "计算机学院",
        major: "计算机科学与技术",
        dormBuilding: "3号楼",
        roomNumber: "408",
        bedNumber: "2号床",
        phone: "13800138001",
        checkinDate: "2023-09-01",
        status: "在住",
        description: "班干部，宿舍长",
        email: "2023001@stu.scgsxy.edu.cn"
      },
      {
        id: "2023002",
        name: "王丽",
        gender: "女",
        college: "外国语学院",
        major: "英语",
        dormBuilding: "2号楼",
        roomNumber: "512",
        bedNumber: "3号床",
        phone: "13800138002",
        checkinDate: "2023-09-01",
        status: "在住",
        description: "英语专业优秀学生",
        email: "2023002@stu.scgsxy.edu.cn"
      },
      {
        id: "2023003",
        name: "李强",
        gender: "男",
        college: "机械工程学院",
        major: "机械工程",
        dormBuilding: "1号楼",
        roomNumber: "306",
        bedNumber: "1号床",
        phone: "13800138003",
        checkinDate: "2023-09-01",
        status: "在住",
        description: "机械创新实验室成员",
        email: "2023003@stu.scgsxy.edu.cn"
      },
      {
        id: "2023004",
        name: "刘芳",
        gender: "女",
        college: "医学院",
        major: "临床医学",
        dormBuilding: "4号楼",
        roomNumber: "209",
        bedNumber: "4号床",
        phone: "13800138004",
        checkinDate: "2023-09-01",
        status: "在住",
        description: "医学院学生会成员",
        email: "2023004@stu.scgsxy.edu.cn"
      },
      {
        id: "2023005",
        name: "陈晨",
        gender: "男",
        college: "经济学院",
        major: "金融学",
        dormBuilding: "5号楼",
        roomNumber: "511",
        bedNumber: "2号床",
        phone: "13800138005",
        checkinDate: "2023-09-01",
        status: "在住",
        description: "金融学专业，爱好篮球",
        email: "2023005@stu.scgsxy.edu.cn"
      }
    ];

    // 宿舍楼性别限制配置
    const dormGenderRestrictions = {
      "1号楼": { gender: "男", label: "男生宿舍" },
      "2号楼": { gender: "女", label: "女生宿舍" },
      "3号楼": { gender: "男", label: "男生宿舍" },
      "4号楼": { gender: "女", label: "女生宿舍" },
      "5号楼": { gender: "男", label: "男生宿舍" },
      "6号楼": { gender: "女", label: "女生宿舍" }
    };

    // 当前显示的数据
    let currentData = [...studentData];
    let currentSearchTerm = '';
    let selectedExportFormat = 'excel';
    let currentEditId = null;
    let currentChangeRoomStudentId = null;

    // DOM元素
    const addStudentBtn = document.getElementById('addStudentBtn');
    const importStudentBtn = document.getElementById('importStudentBtn');
    const exportStudentBtn = document.getElementById('exportStudentBtn');
    const addStudentModal = document.getElementById('addStudentModal');
    const importModal = document.getElementById('importModal');
    const exportModal = document.getElementById('exportModal');
    const changeRoomModal = document.getElementById('changeRoomModal');
    const studentTableBody = document.getElementById('studentTableBody');
    const searchInput = document.getElementById('searchInput');
    const searchHint = document.getElementById('searchHint');
    const resultsCount = document.getElementById('resultsCount');
    const noResults = document.getElementById('noResults');
    const studentDetail = document.getElementById('studentDetail');
    const detailTitle = document.getElementById('detailTitle');
    const detailContent = document.getElementById('detailContent');
    const studentForm = document.getElementById('studentForm');
    const modalTitle = document.getElementById('modalTitle');
    const submitBtn = document.getElementById('submitBtn');

    // 统计卡片元素
    const totalStudentsElement = document.getElementById('totalStudents');
    const studentGrowthElement = document.getElementById('studentGrowth');
    const genderRatioElement = document.getElementById('genderRatio');
    const genderPercentElement = document.getElementById('genderPercent');
    const collegeCountElement = document.getElementById('collegeCount');
    const topCollegeElement = document.getElementById('topCollege');
    const newStudentsElement = document.getElementById('newStudents');
    const newBreakdownElement = document.getElementById('newBreakdown');

    // 学院颜色映射
    const collegeColors = {
      '计算机学院': 'college-1',
      '外国语学院': 'college-2',
      '机械工程学院': 'college-3',
      '医学院': 'college-4',
      '经济学院': 'college-5',
      '文学院': 'college-1',
      '法学院': 'college-2',
      '艺术学院': 'college-3'
    };

    // 初始化页面
    document.addEventListener('DOMContentLoaded', function () {
      renderTable();
      updateStatistics();

      // 设置默认入住时间为今天
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('checkinDate').value = today;
    });

    // 渲染表格
    function renderTable(data = currentData) {
      studentTableBody.innerHTML = '';

      if (data.length === 0) {
        noResults.style.display = 'block';
        resultsCount.innerHTML = '未找到匹配的学生';
        return;
      }

      noResults.style.display = 'none';
      resultsCount.innerHTML = `共找到 ${data.length} 名学生`;

      data.forEach(student => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${student.id}</td>
          <td>${student.name}</td>
          <td><span class="college-badge ${collegeColors[student.college] || 'college-1'}">${student.college}</span></td>
          <td>${student.major}</td>
          <td>${student.dormBuilding} <span class="gender-tag ${student.gender === '男' ? 'male-tag' : 'female-tag'}">${student.gender}</span></td>
          <td>${student.roomNumber}</td>
          <td>${student.bedNumber}</td>
          <td>${formatDate(student.checkinDate)}</td>
          <td>
            <button class="btn btn-primary btn-sm" onclick="viewStudent('${student.id}')">查看</button>
            <button class="btn btn-warning btn-sm" onclick="editStudent('${student.id}')">编辑</button>
            <button class="btn btn-info btn-sm" onclick="openChangeRoomModal('${student.id}')">调换宿舍</button>
          </td>
        `;
        studentTableBody.appendChild(row);
      });
    }

    // 格式化日期
    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
      }).replace(/\//g, '-');
    }

    // 搜索功能
    function searchStudents(term) {
      currentSearchTerm = term.toLowerCase().trim();

      if (currentSearchTerm === '') {
        currentData = [...studentData];
      } else {
        currentData = studentData.filter(student =>
          student.id.toLowerCase().includes(currentSearchTerm) ||
          student.name.toLowerCase().includes(currentSearchTerm) ||
          student.college.toLowerCase().includes(currentSearchTerm) ||
          student.major.toLowerCase().includes(currentSearchTerm) ||
          student.dormBuilding.toLowerCase().includes(currentSearchTerm) ||
          student.roomNumber.toLowerCase().includes(currentSearchTerm)
        );
      }

      renderTable(currentData);
      updateStatistics();
    }

    // 查看学生详情
    function viewStudent(studentId) {
      const student = studentData.find(s => s.id === studentId);
      if (student) {
        detailTitle.textContent = `${student.name} - 详细信息`;
        detailContent.innerHTML = `
          <div class="student-detail-grid">
            <div class="detail-section">
              <h4>基本信息</h4>
              <div class="detail-item">
                <span class="detail-label">学号：</span>
                <span class="detail-value">${student.id}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">姓名：</span>
                <span class="detail-value">${student.name}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">性别：</span>
                <span class="detail-value">${student.gender} <span class="gender-tag ${student.gender === '男' ? 'male-tag' : 'female-tag'}">${student.gender}</span></span>
              </div>
              <div class="detail-item">
                <span class="detail-label">学院：</span>
                <span class="detail-value"><span class="college-badge ${collegeColors[student.college] || 'college-1'}">${student.college}</span></span>
              </div>
              <div class="detail-item">
                <span class="detail-label">专业：</span>
                <span class="detail-value">${student.major}</span>
              </div>
            </div>
            
            <div class="detail-section">
              <h4>住宿信息</h4>
              <div class="detail-item">
                <span class="detail-label">宿舍楼：</span>
                <span class="detail-value">${student.dormBuilding} <span class="gender-tag ${dormGenderRestrictions[student.dormBuilding]?.gender === '男' ? 'male-tag' : 'female-tag'}">${dormGenderRestrictions[student.dormBuilding]?.label || '未知'}</span></span>
              </div>
              <div class="detail-item">
                <span class="detail-label">房间号：</span>
                <span class="detail-value">${student.roomNumber}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">床位号：</span>
                <span class="detail-value">${student.bedNumber}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">入住时间：</span>
                <span class="detail-value">${formatDate(student.checkinDate)}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">住宿状态：</span>
                <span class="detail-value"><span class="status status-processing">${student.status}</span></span>
              </div>
            </div>
            
            <div class="detail-section">
              <h4>联系信息</h4>
              <div class="detail-item">
                <span class="detail-label">联系电话：</span>
                <span class="detail-value">${student.phone || '未填写'}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">邮箱：</span>
                <span class="detail-value">${student.email || '未填写'}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">备注：</span>
                <span class="detail-value">${student.description || '无'}</span>
              </div>
            </div>
          </div>
          
          <div style="margin-top: 20px; text-align: center;">
            <button class="btn btn-primary" onclick="editStudent('${student.id}')">
              <i class="fas fa-edit"></i> 编辑信息
            </button>
            <button class="btn btn-warning" onclick="openChangeRoomModal('${student.id}')" style="margin-left: 10px;">
              <i class="fas fa-exchange-alt"></i> 调换宿舍
            </button>
          </div>
        `;

        studentDetail.style.display = 'block';
        studentDetail.scrollIntoView({ behavior: 'smooth' });
      }
    }

    // 关闭详情
    function closeDetail() {
      studentDetail.style.display = 'none';
    }

    // 更新宿舍楼选项（根据性别筛选）
    function updateDormBuildingOptions() {
      const gender = document.getElementById('gender').value;
      const dormBuildingSelect = document.getElementById('dormBuilding');

      // 清空选项
      dormBuildingSelect.innerHTML = '<option value="">请选择宿舍楼</option>';

      if (gender) {
        // 根据性别筛选宿舍楼
        Object.entries(dormGenderRestrictions).forEach(([building, info]) => {
          if (info.gender === gender) {
            const option = document.createElement('option');
            option.value = building;
            option.textContent = `${building} (${info.label})`;
            dormBuildingSelect.appendChild(option);
          }
        });
      } else {
        // 如果没有选择性别，显示所有宿舍楼
        Object.entries(dormGenderRestrictions).forEach(([building, info]) => {
          const option = document.createElement('option');
          option.value = building;
          option.textContent = `${building} (${info.label})`;
          dormBuildingSelect.appendChild(option);
        });
      }
    }

    // 检查床位是否可用
    function checkBedAvailability() {
      const dormBuilding = document.getElementById('dormBuilding').value;
      const roomNumber = document.getElementById('roomNumber').value;
      const bedNumberSelect = document.getElementById('bedNumber');
      const validationMessage = document.getElementById('validationMessage');

      if (!dormBuilding || !roomNumber) return;

      // 检查该房间的已占用床位
      const occupiedBeds = studentData
        .filter(student =>
          student.dormBuilding === dormBuilding &&
          student.roomNumber === roomNumber
        )
        .map(student => student.bedNumber);

      // 更新床位选项
      const bedOptions = ['1号床', '2号床', '3号床', '4号床'];
      bedNumberSelect.innerHTML = '<option value="">请选择床位号</option>';

      bedOptions.forEach(bed => {
        const option = document.createElement('option');
        option.value = bed;
        option.textContent = bed;

        if (occupiedBeds.includes(bed)) {
          option.textContent += ' (已占用)';
          option.disabled = true;
        }

        bedNumberSelect.appendChild(option);
      });

      // 显示验证信息
      const availableBeds = 4 - occupiedBeds.length;
      if (availableBeds === 0) {
        validationMessage.textContent = '⚠️ 该房间床位已满，请选择其他房间';
        validationMessage.style.display = 'block';
        validationMessage.style.backgroundColor = '#ffebee';
        validationMessage.style.color = '#d32f2f';
      } else {
        validationMessage.textContent = `✅ 该房间还有 ${availableBeds} 个空床位`;
        validationMessage.style.display = 'block';
        validationMessage.style.backgroundColor = '#e8f5e9';
        validationMessage.style.color = '#388e3c';
      }
    }

    // 检查房间是否符合性别限制
    function checkAvailableRooms() {
      const gender = document.getElementById('gender').value;
      const dormBuilding = document.getElementById('dormBuilding').value;
      const validationMessage = document.getElementById('validationMessage');

      if (!gender || !dormBuilding) return;

      // 检查宿舍楼性别限制
      const restriction = dormGenderRestrictions[dormBuilding];

      if (restriction && restriction.gender !== gender) {
        validationMessage.textContent = `⚠️ 错误：${gender}生不能入住${restriction.label}！`;
        validationMessage.style.display = 'block';
        validationMessage.style.backgroundColor = '#ffebee';
        validationMessage.style.color = '#d32f2f';

        // 清空房间号和床位号
        document.getElementById('roomNumber').value = '';
        document.getElementById('bedNumber').innerHTML = '<option value="">请选择床位号</option>';

        // 禁用提交按钮
        document.getElementById('submitBtn').disabled = true;
      } else {
        validationMessage.style.display = 'none';
        document.getElementById('submitBtn').disabled = false;
        checkBedAvailability(); // 检查床位可用性
      }
    }

    // 编辑学生
    function editStudent(studentId) {
      const student = studentData.find(s => s.id === studentId);
      if (student) {
        currentEditId = studentId;
        modalTitle.textContent = '编辑学生信息';
        submitBtn.textContent = '确认修改';

        // 填充表单
        document.getElementById('studentId').value = student.id;
        document.getElementById('studentName').value = student.name;
        document.getElementById('gender').value = student.gender;
        document.getElementById('college').value = student.college;
        document.getElementById('major').value = student.major;
        document.getElementById('phone').value = student.phone || '';
        document.getElementById('dormBuilding').value = student.dormBuilding;
        document.getElementById('roomNumber').value = student.roomNumber;
        document.getElementById('checkinDate').value = student.checkinDate;
        document.getElementById('studentDesc').value = student.description || '';

        // 更新宿舍楼选项
        updateDormBuildingOptions();

        // 设置床位号
        const bedNumberSelect = document.getElementById('bedNumber');
        bedNumberSelect.innerHTML = '<option value="">请选择床位号</option>';
        const bedOptions = ['1号床', '2号床', '3号床', '4号床'];
        bedOptions.forEach(bed => {
          const option = document.createElement('option');
          option.value = bed;
          option.textContent = bed;
          if (bed === student.bedNumber) {
            option.selected = true;
          }
          bedNumberSelect.appendChild(option);
        });

        // 显示模态框
        addStudentModal.style.display = 'flex';
      }
    }

    // 打开调换宿舍模态框
    function openChangeRoomModal(studentId) {
      const student = studentData.find(s => s.id === studentId);
      if (student) {
        currentChangeRoomStudentId = studentId;

        // 显示当前学生信息
        document.getElementById('currentStudentInfo').innerHTML = `
          <div style="background-color: #f8fafd; padding: 15px; border-radius: 8px; border-left: 4px solid #2a5bd7;">
            <h4 style="margin-top: 0;">当前住宿信息</h4>
            <div style="display: flex; justify-content: space-between;">
              <div>
                <strong>姓名：</strong> ${student.name} (${student.gender})<br>
                <strong>当前宿舍：</strong> ${student.dormBuilding} ${student.roomNumber} ${student.bedNumber}
              </div>
              <div>
                <strong>学院：</strong> ${student.college}<br>
                <strong>专业：</strong> ${student.major}
              </div>
            </div>
          </div>
        `;

        // 更新宿舍楼选项（根据性别筛选）
        const newDormBuildingSelect = document.getElementById('newDormBuilding');
        newDormBuildingSelect.innerHTML = '<option value="">请选择宿舍楼</option>';

        Object.entries(dormGenderRestrictions).forEach(([building, info]) => {
          if (info.gender === student.gender && building !== student.dormBuilding) {
            const option = document.createElement('option');
            option.value = building;
            option.textContent = `${building} (${info.label})`;
            newDormBuildingSelect.appendChild(option);
          }
        });

        // 清空之前的选项
        document.getElementById('roomOptions').innerHTML = '';
        document.getElementById('bedSelection').style.display = 'none';
        document.getElementById('changeRoomMessage').style.display = 'none';

        changeRoomModal.style.display = 'flex';
      }
    }

    // 加载可用房间
    function loadAvailableRooms() {
      const student = studentData.find(s => s.id === currentChangeRoomStudentId);
      const newDormBuilding = document.getElementById('newDormBuilding').value;
      const roomOptions = document.getElementById('roomOptions');

      if (!student || !newDormBuilding) return;

      // 获取该宿舍楼的所有房间
      const rooms = {};
      studentData.forEach(s => {
        if (s.dormBuilding === newDormBuilding) {
          if (!rooms[s.roomNumber]) {
            rooms[s.roomNumber] = [];
          }
          rooms[s.roomNumber].push(s.bedNumber);
        }
      });

      roomOptions.innerHTML = '';

      // 显示房间选项（最多显示6个房间）
      const roomNumbers = ['101', '102', '103', '201', '202', '203', '301', '302', '303', '401', '402', '403'];

      roomNumbers.forEach(roomNumber => {
        const occupiedBeds = rooms[roomNumber] || [];
        const availableBeds = 4 - occupiedBeds.length;

        if (availableBeds > 0) {
          const roomOption = document.createElement('div');
          roomOption.className = 'room-option';
          roomOption.setAttribute('data-room', roomNumber);
          roomOption.innerHTML = `
            <div class="room-info">
              <div>
                <strong>${newDormBuilding} ${roomNumber}</strong>
                <span class="room-gender">${dormGenderRestrictions[newDormBuilding].label}</span>
              </div>
              <div>
                <span class="bed-status ${availableBeds > 0 ? 'bed-available' : 'bed-occupied'}">
                  ${availableBeds}个空床位
                </span>
              </div>
            </div>
            <div style="font-size: 12px; color: #666; margin-top: 5px;">
              已占用：${occupiedBeds.join(', ')}
            </div>
          `;

          roomOption.addEventListener('click', function () {
            document.querySelectorAll('.room-option').forEach(opt => opt.classList.remove('selected'));
            this.classList.add('selected');

            // 加载床位选项
            const selectedRoom = this.getAttribute('data-room');
            loadBedOptions(newDormBuilding, selectedRoom);
          });

          roomOptions.appendChild(roomOption);
        }
      });

      document.getElementById('changeRoomMessage').style.display = 'none';
    }

    // 加载床位选项
    function loadBedOptions(dormBuilding, roomNumber) {
      const bedSelection = document.getElementById('bedSelection');
      const newBedNumberSelect = document.getElementById('newBedNumber');

      // 获取已占用的床位
      const occupiedBeds = studentData
        .filter(student =>
          student.dormBuilding === dormBuilding &&
          student.roomNumber === roomNumber
        )
        .map(student => student.bedNumber);

      // 更新床位选项
      newBedNumberSelect.innerHTML = '<option value="">请选择床位号</option>';

      const bedOptions = ['1号床', '2号床', '3号床', '4号床'];
      bedOptions.forEach(bed => {
        if (!occupiedBeds.includes(bed)) {
          const option = document.createElement('option');
          option.value = bed;
          option.textContent = bed;
          newBedNumberSelect.appendChild(option);
        }
      });

      bedSelection.style.display = 'block';
    }

    // 确认调换宿舍
    function confirmChangeRoom() {
      const student = studentData.find(s => s.id === currentChangeRoomStudentId);
      const newDormBuilding = document.getElementById('newDormBuilding').value;
      const newBedNumber = document.getElementById('newBedNumber').value;
      const changeRoomMessage = document.getElementById('changeRoomMessage');

      if (!student || !newDormBuilding || !newBedNumber) {
        changeRoomMessage.textContent = '请选择完整的宿舍和床位信息！';
        changeRoomMessage.style.display = 'block';
        return;
      }

      // 验证床位是否被占用（再次检查）
      const isBedOccupied = studentData.some(s =>
        s.dormBuilding === newDormBuilding &&
        s.roomNumber === document.querySelector('.room-option.selected')?.getAttribute('data-room') &&
        s.bedNumber === newBedNumber
      );

      if (isBedOccupied) {
        changeRoomMessage.textContent = '该床位已被占用，请选择其他床位！';
        changeRoomMessage.style.display = 'block';
        return;
      }

      // 更新学生宿舍信息
      const roomNumber = document.querySelector('.room-option.selected')?.getAttribute('data-room');
      student.dormBuilding = newDormBuilding;
      student.roomNumber = roomNumber;
      student.bedNumber = newBedNumber;

      // 更新表格和统计
      searchStudents(currentSearchTerm);
      updateStatistics();

      // 关闭模态框
      closeModal('changeRoom');
      alert('宿舍调换成功！');

      // 刷新学生详情
      if (studentDetail.style.display === 'block') {
        viewStudent(currentChangeRoomStudentId);
      }
    }

    // 添加学生
    addStudentBtn.addEventListener('click', function () {
      currentEditId = null;
      modalTitle.textContent = '添加学生';
      submitBtn.textContent = '确认添加';
      studentForm.reset();

      // 设置默认入住时间为今天
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('checkinDate').value = today;

      // 清空验证信息
      document.getElementById('validationMessage').style.display = 'none';

      // 重置床位选项
      document.getElementById('bedNumber').innerHTML = '<option value="">请选择床位号</option>';
      const bedOptions = ['1号床', '2号床', '3号床', '4号床'];
      bedOptions.forEach(bed => {
        const option = document.createElement('option');
        option.value = bed;
        option.textContent = bed;
        document.getElementById('bedNumber').appendChild(option);
      });

      addStudentModal.style.display = 'flex';
    });

    // 批量导入
    importStudentBtn.addEventListener('click', function () {
      importModal.style.display = 'flex';
    });

    // 导出数据
    exportStudentBtn.addEventListener('click', function () {
      exportModal.style.display = 'flex';
    });

    // 表单提交处理
    studentForm.addEventListener('submit', function (e) {
      e.preventDefault();

      // 获取表单数据
      const studentId = document.getElementById('studentId').value;
      const studentName = document.getElementById('studentName').value;
      const gender = document.getElementById('gender').value;
      const college = document.getElementById('college').value;
      const major = document.getElementById('major').value;
      const phone = document.getElementById('phone').value;
      const dormBuilding = document.getElementById('dormBuilding').value;
      const roomNumber = document.getElementById('roomNumber').value;
      const bedNumber = document.getElementById('bedNumber').value;
      const checkinDate = document.getElementById('checkinDate').value;
      const studentDesc = document.getElementById('studentDesc').value;
      const validationMessage = document.getElementById('validationMessage');

      // 验证性别与宿舍楼匹配
      const restriction = dormGenderRestrictions[dormBuilding];
      if (restriction && restriction.gender !== gender) {
        validationMessage.textContent = `错误：${gender}生不能入住${restriction.label}！`;
        validationMessage.style.display = 'block';
        return;
      }

      // 验证学号是否重复
      if (currentEditId === null) {
        const existingStudent = studentData.find(s => s.id === studentId);
        if (existingStudent) {
          validationMessage.textContent = '学号已存在，请使用不同的学号！';
          validationMessage.style.display = 'block';
          return;
        }
      }

      // 验证床位是否可用
      const isBedOccupied = studentData.some(s =>
        s.dormBuilding === dormBuilding &&
        s.roomNumber === roomNumber &&
        s.bedNumber === bedNumber &&
        (!currentEditId || s.id !== currentEditId)
      );

      if (isBedOccupied) {
        validationMessage.textContent = '该床位已被占用，请选择其他床位！';
        validationMessage.style.display = 'block';
        return;
      }

      const studentDataObj = {
        id: studentId,
        name: studentName,
        gender: gender,
        college: college,
        major: major,
        dormBuilding: dormBuilding,
        roomNumber: roomNumber,
        bedNumber: bedNumber,
        phone: phone,
        checkinDate: checkinDate,
        status: "在住",
        description: studentDesc,
        email: `${studentId}@stu.scgsxy.edu.cn`
      };

      if (currentEditId) {
        // 编辑模式
        const index = studentData.findIndex(s => s.id === currentEditId);
        if (index !== -1) {
          studentData[index] = studentDataObj;
          alert('学生信息修改成功！');
        }
      } else {
        // 添加模式
        studentData.push(studentDataObj);
        alert('学生添加成功！');
      }

      // 重新搜索和渲染表格
      searchStudents(currentSearchTerm);
      updateStatistics();
      closeModal('add');
    });

    // 更新统计信息
    function updateStatistics() {
      const totalStudents = studentData.length;
      const maleStudents = studentData.filter(s => s.gender === '男').length;
      const femaleStudents = studentData.filter(s => s.gender === '女').length;
      const malePercent = Math.round((maleStudents / totalStudents) * 100) || 0;
      const femalePercent = Math.round((femaleStudents / totalStudents) * 100) || 0;

      // 按学院统计
      const collegeStats = {};
      studentData.forEach(student => {
        if (!collegeStats[student.college]) {
          collegeStats[student.college] = 0;
        }
        collegeStats[student.college]++;
      });

      const collegeCount = Object.keys(collegeStats).length;
      let topCollege = '';
      let maxCount = 0;

      for (const [college, count] of Object.entries(collegeStats)) {
        if (count > maxCount) {
          maxCount = count;
          topCollege = college;
        }
      }

      // 模拟数据
      const growthRate = Math.floor(Math.random() * 5) + 1;
      const newStudents = Math.floor(Math.random() * 50) + 80;
      const newFreshmen = Math.floor(newStudents * 0.9);
      const transfers = newStudents - newFreshmen;

      // 更新统计卡片
      totalStudentsElement.textContent = totalStudents.toLocaleString();
      studentGrowthElement.textContent = `较上月增长 ${growthRate}%`;
      genderRatioElement.textContent = `${maleStudents} | ${femaleStudents}`;
      genderPercentElement.textContent = `男生: ${malePercent}% | 女生: ${femalePercent}%`;
      collegeCountElement.textContent = collegeCount;
      topCollegeElement.textContent = `${topCollege}人数最多: ${maxCount}人`;
      newStudentsElement.textContent = newStudents;
      newBreakdownElement.textContent = `其中: 新生 ${newFreshmen}人 | 调宿 ${transfers}人`;
    }

    // 关闭模态框
    function closeModal(modalId) {
      if (modalId === 'add') {
        addStudentModal.style.display = 'none';
        studentForm.reset();
        currentEditId = null;
        document.getElementById('validationMessage').style.display = 'none';
      } else if (modalId === 'import') {
        importModal.style.display = 'none';
        document.getElementById('fileList').style.display = 'none';
        document.getElementById('importProgress').style.display = 'none';
      } else if (modalId === 'export') {
        exportModal.style.display = 'none';
        document.getElementById('exportProgress').style.display = 'none';
        document.getElementById('exportProgressBar').style.width = '0%';
      } else if (modalId === 'changeRoom') {
        changeRoomModal.style.display = 'none';
        currentChangeRoomStudentId = null;
        document.getElementById('changeRoomMessage').style.display = 'none';
      }
    }

    // 事件监听
    document.getElementById('closeModalBtn').addEventListener('click', () => closeModal('add'));
    document.getElementById('closeImportBtn').addEventListener('click', () => closeModal('import'));
    document.getElementById('closeExportBtn').addEventListener('click', () => closeModal('export'));
    document.getElementById('closeChangeRoomBtn').addEventListener('click', () => closeModal('changeRoom'));
    document.getElementById('cancelBtn').addEventListener('click', () => closeModal('add'));
    document.getElementById('cancelImportBtn').addEventListener('click', () => closeModal('import'));
    document.getElementById('cancelExportBtn').addEventListener('click', () => closeModal('export'));
    document.getElementById('cancelChangeRoomBtn').addEventListener('click', () => closeModal('changeRoom'));

    // 确认调换宿舍按钮事件
    document.getElementById('confirmChangeRoomBtn').addEventListener('click', confirmChangeRoom);

    // 搜索框事件
    searchInput.addEventListener('input', function () {
      searchStudents(this.value);
    });

    searchInput.addEventListener('focus', function () {
      searchHint.style.display = 'block';
    });

    searchInput.addEventListener('blur', function () {
      setTimeout(() => {
        searchHint.style.display = 'none';
      }, 200);
    });

    // 批量导入功能
    const importArea = document.getElementById('importArea');
    const fileInput = document.getElementById('fileInput');
    const startImportBtn = document.getElementById('startImportBtn');
    const fileList = document.getElementById('fileList');
    const importProgress = document.getElementById('importProgress');
    const importProgressBar = document.getElementById('importProgressBar');
    const importStatus = document.getElementById('importStatus');

    importArea.addEventListener('click', () => fileInput.click());
    importArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      importArea.style.borderColor = '#2a5bd7';
    });
    importArea.addEventListener('dragleave', () => {
      importArea.style.borderColor = '#ddd';
    });
    importArea.addEventListener('drop', (e) => {
      e.preventDefault();
      importArea.style.borderColor = '#ddd';
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        handleFileSelect(files[0]);
      }
    });

    fileInput.addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        handleFileSelect(e.target.files[0]);
      }
    });

    function handleFileSelect(file) {
      const fileName = file.name;
      const fileSize = (file.size / 1024 / 1024).toFixed(2); // MB

      if (fileSize > 10) {
        alert('文件大小不能超过10MB！');
        return;
      }

      const allowedExtensions = ['.xlsx', '.xls', '.csv'];
      const fileExt = fileName.substring(fileName.lastIndexOf('.')).toLowerCase();

      if (!allowedExtensions.includes(fileExt)) {
        alert('只支持 Excel (.xlsx, .xls) 或 CSV (.csv) 格式的文件！');
        return;
      }

      fileList.innerHTML = `
        <div class="file-item">
          <div class="file-info">
            <i class="fas fa-file-excel"></i>
            <div>
              <strong>${fileName}</strong>
              <div style="font-size: 12px; color: #666;">${fileSize} MB</div>
            </div>
          </div>
          <button class="btn btn-sm btn-secondary" onclick="clearFile()">
            <i class="fas fa-times"></i>
          </button>
        </div>
      `;

      fileList.style.display = 'block';
      startImportBtn.disabled = false;
    }

    window.clearFile = function () {
      fileInput.value = '';
      fileList.style.display = 'none';
      startImportBtn.disabled = true;
    };

    startImportBtn.addEventListener('click', function () {
      importProgress.style.display = 'block';
      let progress = 0;

      const progressInterval = setInterval(() => {
        progress += 20;
        importProgressBar.style.width = `${progress}%`;
        importStatus.textContent = `正在导入数据... ${progress}%`;

        if (progress >= 100) {
          clearInterval(progressInterval);

          // 模拟导入5个学生（确保性别与宿舍楼匹配）
          const newStudents = [];
          for (let i = 0; i < 5; i++) {
            const gender = i % 2 === 0 ? '男' : '女';
            const dormBuilding = gender === '男' ?
              ['1号楼', '3号楼', '5号楼'][Math.floor(Math.random() * 3)] :
              ['2号楼', '4号楼', '6号楼'][Math.floor(Math.random() * 3)];

            const newId = (parseInt(studentData[studentData.length - 1]?.id || '2023000') + i + 1).toString();
            newStudents.push({
              id: newId,
              name: `导入学生${i + 1}`,
              gender: gender,
              college: ['计算机学院', '外国语学院', '机械工程学院', '医学院', '经济学院'][i],
              major: '测试专业',
              dormBuilding: dormBuilding,
              roomNumber: `${100 + i}`,
              bedNumber: `${(i % 4) + 1}号床`,
              phone: `13800138${100 + i}`,
              checkinDate: new Date().toISOString().split('T')[0],
              status: "在住",
              description: "批量导入的学生",
              email: `${newId}@stu.scgsxy.edu.cn`
            });
          }

          studentData.push(...newStudents);

          setTimeout(() => {
            searchStudents(currentSearchTerm);
            updateStatistics();
            closeModal('import');
            alert(`成功导入 ${newStudents.length} 名学生数据！`);
          }, 500);
        }
      }, 200);
    });

    // 导出功能
    document.querySelectorAll('.export-option').forEach(option => {
      option.addEventListener('click', function () {
        document.querySelectorAll('.export-option').forEach(opt => opt.classList.remove('selected'));
        this.classList.add('selected');
        selectedExportFormat = this.getAttribute('data-format');
      });
    });

    document.getElementById('confirmExportBtn').addEventListener('click', function () {
      const exportRange = document.querySelector('input[name="exportRange"]:checked').value;
      const exportCollege = document.getElementById('exportCollege').value;
      const fileName = document.getElementById('exportFileName').value || '住宿学生数据';

      let dataToExport = [];

      if (exportRange === 'all') {
        dataToExport = [...studentData];
      } else if (exportRange === 'current') {
        dataToExport = [...currentData];
      } else if (exportRange === 'selected') {
        dataToExport = studentData.filter(student => student.college === exportCollege);
      }

      if (dataToExport.length === 0) {
        alert('没有可导出的数据！');
        return;
      }

      const exportProgress = document.getElementById('exportProgress');
      const exportProgressBar = document.getElementById('exportProgressBar');

      exportProgress.style.display = 'block';
      let progress = 0;
      const progressInterval = setInterval(() => {
        progress += 20;
        exportProgressBar.style.width = `${progress}%`;

        if (progress >= 100) {
          clearInterval(progressInterval);

          let fileExtension = '';
          let mimeType = '';

          switch (selectedExportFormat) {
            case 'excel':
              fileExtension = 'xlsx';
              mimeType = 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';
              break;
            case 'csv':
              fileExtension = 'csv';
              mimeType = 'text/csv';
              break;
            case 'pdf':
              fileExtension = 'pdf';
              mimeType = 'application/pdf';
              break;
          }

          // 创建导出数据
          const exportData = dataToExport.map(student => ({
            学号: student.id,
            姓名: student.name,
            性别: student.gender,
            学院: student.college,
            专业: student.major,
            宿舍楼: student.dormBuilding,
            房间号: student.roomNumber,
            床位号: student.bedNumber,
            联系电话: student.phone || '',
            入住时间: formatDate(student.checkinDate),
            邮箱: student.email || '',
            备注: student.description || ''
          }));

          // 模拟文件下载
          const dataStr = JSON.stringify(exportData, null, 2);
          const dataBlob = new Blob([dataStr], { type: mimeType });
          const url = URL.createObjectURL(dataBlob);
          const link = document.createElement('a');
          link.href = url;
          link.download = `${fileName}.${fileExtension}`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);

          setTimeout(() => {
            exportProgress.style.display = 'none';
            exportProgressBar.style.width = '0%';
            closeModal('export');
            alert(`数据已成功导出为${fileName}.${fileExtension}文件！`);
          }, 500);
        }
      }, 200);
    });

    // 下载导入模板
    window.downloadTemplate = function () {
      const templateData = [
        ['学号', '姓名', '性别', '学院', '专业', '宿舍楼', '房间号', '床位号', '联系电话', '入住时间', '备注'],
        ['20231001', '张三', '男', '计算机学院', '计算机科学与技术', '1号楼', '101', '1号床', '13800138000', '2023-09-01', '新生'],
        ['20231002', '李四', '女', '外国语学院', '英语', '2号楼', '201', '2号床', '13800138001', '2023-09-01', '新生']
      ];

      const csvContent = templateData.map(row => row.join(',')).join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = '学生信息导入模板.csv';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      alert('模板文件已下载！');
    };

    // 点击模态框背景关闭
    addStudentModal.addEventListener('click', function (e) {
      if (e.target === addStudentModal) closeModal('add');
    });

    importModal.addEventListener('click', function (e) {
      if (e.target === importModal) closeModal('import');
    });

    exportModal.addEventListener('click', function (e) {
      if (e.target === exportModal) closeModal('export');
    });

    changeRoomModal.addEventListener('click', function (e) {
      if (e.target === changeRoomModal) closeModal('changeRoom');
    });
  </script>
</body>

</html>