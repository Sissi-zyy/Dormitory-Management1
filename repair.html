<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>宿舍管理系统 - 报修管理</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Noto Sans SC', sans-serif;
      background-color: #f5f7fa;
      color: #333;
      line-height: 1.6;
    }

    .container {
      display: flex;
      min-height: 100vh;
    }

    /* 侧边栏样式 */
    .sidebar {
      width: 240px;
      background: linear-gradient(180deg, #1e3c72 0%, #2a5298 100%);
      color: white;
      padding: 20px 0;
      box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
      z-index: 100;
    }

    .logo-area {
      padding: 0 20px 30px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .logo {
      display: flex;
      align-items: center;
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 10px;
    }

    .logo i {
      margin-right: 12px;
      font-size: 24px;
    }

    .campus-info {
      font-size: 12px;
      opacity: 0.8;
      padding-left: 36px;
    }

    .nav-links {
      list-style: none;
      padding: 20px 0;
    }

    .nav-links li {
      margin: 5px 0;
    }

    .nav-links a {
      display: flex;
      align-items: center;
      padding: 12px 20px;
      color: rgba(255, 255, 255, 0.8);
      text-decoration: none;
      transition: all 0.3s;
      border-left: 4px solid transparent;
    }

    .nav-links a:hover,
    .nav-links a.active {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border-left-color: #4CAF50;
    }

    .nav-links i {
      width: 24px;
      margin-right: 12px;
      font-size: 16px;
    }

    /* 主要内容区域 */
    .main-content {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
    }

    /* 头部样式 */
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid #e0e6ef;
    }

    .header-title h1 {
      font-size: 28px;
      color: #2c3e50;
      margin-bottom: 5px;
    }

    .header-title p {
      color: #7f8c8d;
      font-size: 14px;
    }

    .header-controls {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .search-bar {
      position: relative;
      background: white;
      border-radius: 25px;
      padding: 8px 15px 8px 40px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      border: 1px solid #e0e6ef;
    }

    .search-bar i {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: #95a5a6;
    }

    .search-bar input {
      border: none;
      outline: none;
      width: 200px;
      background: transparent;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      background: #3498db;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .user-details h3 {
      font-size: 16px;
      font-weight: 600;
    }

    .user-details p {
      font-size: 12px;
      color: #7f8c8d;
    }

    /* 统计卡片 */
    .repair-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-item {
      background: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
      border-top: 4px solid #3498db;
      transition: transform 0.3s;
    }

    .stat-item:hover {
      transform: translateY(-5px);
    }

    .stat-item:nth-child(2) {
      border-top-color: #e74c3c;
    }

    .stat-item:nth-child(3) {
      border-top-color: #f39c12;
    }

    .stat-item:nth-child(4) {
      border-top-color: #2ecc71;
    }

    .stat-value {
      font-size: 36px;
      font-weight: 700;
      color: #2c3e50;
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 14px;
      color: #7f8c8d;
    }

    /* 按钮样式 */
    .action-buttons {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s;
      font-family: 'Noto Sans SC', sans-serif;
    }

    .btn-primary {
      background: #3498db;
      color: white;
    }

    .btn-success {
      background: #27ae60;
      color: white;
    }

    .btn-warning {
      background: #f39c12;
      color: white;
    }

    .btn-danger {
      background: #e74c3c;
      color: white;
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 13px;
    }

    .btn:hover {
      opacity: 0.9;
      transform: translateY(-2px);
    }

    /* 选项卡 */
    .repair-tabs {
      display: flex;
      background: white;
      border-radius: 5px;
      overflow: hidden;
      margin-bottom: 25px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }

    .repair-tab {
      flex: 1;
      padding: 15px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      border-bottom: 3px solid transparent;
    }

    .repair-tab.active {
      background: #f8f9fa;
      border-bottom-color: #3498db;
      font-weight: 600;
      color: #3498db;
    }

    .repair-tab:hover:not(.active) {
      background: #f8f9fa;
    }

    /* 报修表单 */
    .repair-form {
      background: white;
      padding: 25px;
      border-radius: 10px;
      margin-bottom: 25px;
      box-shadow: 0 3px 15px rgba(0, 0, 0, 0.05);
    }

    .repair-form h3 {
      margin-bottom: 20px;
      color: #2c3e50;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #2c3e50;
    }

    .form-control {
      width: 100%;
      padding: 10px 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-family: 'Noto Sans SC', sans-serif;
      transition: border 0.3s;
    }

    .form-control:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
    }

    textarea.form-control {
      resize: vertical;
      min-height: 100px;
    }

    /* 报修卡片 */
    #repairList {
      display: grid;
      gap: 15px;
    }

    .repair-card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      border-left: 4px solid #3498db;
      transition: all 0.3s;
    }

    .repair-card:hover {
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
      transform: translateY(-2px);
    }

    .repair-card.emergency {
      border-left-color: #e74c3c;
      background: linear-gradient(to right, #fff 0%, #fff9f9 100%);
    }

    .repair-card.completed {
      border-left-color: #2ecc71;
      background: linear-gradient(to right, #fff 0%, #f9fff9 100%);
    }

    .repair-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .repair-title {
      font-size: 18px;
      font-weight: 600;
      color: #2c3e50;
    }

    .repair-card p {
      color: #555;
      margin-bottom: 15px;
      line-height: 1.6;
    }

    .repair-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      font-size: 13px;
      color: #7f8c8d;
      margin-bottom: 15px;
    }

    .repair-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    /* 状态标签 */
    .status {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .status-pending {
      background: #ffebee;
      color: #e74c3c;
    }

    .status-processing {
      background: #fff8e1;
      color: #f39c12;
    }

    .status-completed {
      background: #e8f5e9;
      color: #27ae60;
    }

    /* 页脚 */
    .footer {
      margin-top: 40px;
      padding-top: 20px;
      border-top: 1px solid #e0e6ef;
      text-align: center;
      color: #7f8c8d;
      font-size: 14px;
    }

    /* 模态框 */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 10px;
      width: 90%;
      max-width: 500px;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-header h3 {
      color: #2c3e50;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #95a5a6;
    }

    /* 空状态 */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .empty-state i {
      font-size: 48px;
      color: #bdc3c7;
      margin-bottom: 15px;
    }

    .empty-state h3 {
      color: #7f8c8d;
      margin-bottom: 10px;
    }

    /* 响应式设计 */
    @media (max-width: 768px) {
      .container {
        flex-direction: column;
      }

      .sidebar {
        width: 100%;
        padding: 15px;
      }

      .nav-links {
        display: flex;
        overflow-x: auto;
        padding: 10px 0;
      }

      .nav-links li {
        flex-shrink: 0;
      }

      .nav-links a {
        padding: 10px;
        border-left: none;
        border-bottom: 3px solid transparent;
      }

      .nav-links a:hover,
      .nav-links a.active {
        border-left: none;
        border-bottom-color: #4CAF50;
      }

      header {
        flex-direction: column;
        gap: 15px;
        align-items: flex-start;
      }

      .header-controls {
        width: 100%;
        justify-content: space-between;
      }

      .search-bar input {
        width: 150px;
      }

      .action-buttons {
        flex-direction: column;
      }

      .repair-tabs {
        flex-wrap: wrap;
      }

      .repair-tab {
        min-width: calc(50% - 1px);
      }

      .form-row {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <aside class="sidebar">
      <div class="logo-area">
        <div class="logo">
          <i class="fas fa-hotel"></i>
          <span>宿舍管理系统</span>
        </div>
        <div class="campus-info">四川工商学院学生宿舍管理中心</div>
      </div>
      <ul class="nav-links">
        <li><a href="index.html"><i class="fas fa-home"></i><span>系统首页</span></a></li>
        <li><a href="dorm-management.html"><i class="fas fa-building"></i><span>宿舍楼管理</span></a></li>
        <li><a href="student.html"><i class="fas fa-user-friends"></i><span>住宿学生</span></a></li>
        <li><a href="bed-assignment.html"><i class="fas fa-bed"></i><span>床位分配</span></a></li>
        <li><a href="repair.html" class="active"><i class="fas fa-tools"></i><span>报修管理</span></a></li>
        <li><a href="visitor.html"><i class="fas fa-user-check"></i><span>访客登记</span></a></li>
        <li><a href="statistics.html"><i class="fas fa-chart-bar"></i><span>数据统计</span></a></li>
        <li><a href="settings.html"><i class="fas fa-cog"></i><span>系统设置</span></a></li>

      </ul>
    </aside>

    <main class="main-content">
      <header>
        <div class="header-title">
          <h1>报修管理</h1>
          <p>设施报修申请、处理和跟踪</p>
        </div>
        <div class="header-controls">
          <div class="search-bar">
            <i class="fas fa-search"></i>
            <input type="text" placeholder="搜索报修记录...">
          </div>
          <div class="user-info">
            <div class="user-avatar">
              <i class="fas fa-user-tie"></i>
            </div>
            <div class="user-details">
              <h3>李管理员</h3>
              <p>宿舍管理中心</p>
            </div>
          </div>
        </div>
      </header>

      <div class="repair-stats">
        <div class="stat-item">
          <div class="stat-value" id="pendingCount">24</div>
          <div class="stat-label">待处理报修</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="emergencyCount">5</div>
          <div class="stat-label">紧急报修</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="processingCount">18</div>
          <div class="stat-label">处理中</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="completedCount">156</div>
          <div class="stat-label">本月已完成</div>
        </div>
      </div>

      <div class="action-buttons">
        <button class="btn btn-primary" id="newRepairBtn">
          <i class="fas fa-plus"></i> 新建报修
        </button>
        <button class="btn btn-success" id="assignRepairBtn">
          <i class="fas fa-user-check"></i> 分配维修员
        </button>
        <button class="btn btn-warning" id="exportBtn">
          <i class="fas fa-file-export"></i> 导出记录
        </button>
        <button class="btn btn-danger" id="emergencyBtn">
          <i class="fas fa-exclamation-triangle"></i> 紧急报修
        </button>
      </div>

      <div class="repair-tabs">
        <div class="repair-tab active" data-tab="pending" onclick="switchTab('pending')">待处理 (<span
            id="pendingTabCount">24</span>)</div>
        <div class="repair-tab" data-tab="processing" onclick="switchTab('processing')">处理中 (<span
            id="processingTabCount">18</span>)</div>
        <div class="repair-tab" data-tab="completed" onclick="switchTab('completed')">已完成 (<span
            id="completedTabCount">156</span>)</div>
        <div class="repair-tab" data-tab="all" onclick="switchTab('all')">全部记录</div>
      </div>

      <!-- 报修列表 -->
      <div id="repairList">
        <!-- 动态生成 -->
      </div>

      <footer class="footer">
        <p>© 2023 四川工商学院宿舍管理中心. 版权所有. 系统版本: 2.1.0</p>
      </footer>
    </main>
  </div>

  <script>
    // 全局变量
    let currentTab = 'pending';
    let repairData = {
      pending: [
        {
          id: 1,
          title: '3号楼408宿舍空调故障',
          description: '空调制冷效果差，有异常噪音，急需维修',
          reporter: '张明',
          dorm: '3号楼-408',
          time: '2023-10-15 14:30',
          type: '电器故障',
          urgency: '紧急',
          status: 'pending'
        },
        {
          id: 2,
          title: '2号楼512宿舍水管漏水',
          description: '洗手间水管接口处漏水严重，需要紧急处理',
          reporter: '王丽',
          dorm: '2号楼-512',
          time: '2023-10-14 09:15',
          type: '水管问题',
          urgency: '紧急',
          status: 'pending'
        },
        {
          id: 3,
          title: '4号楼201宿舍灯管不亮',
          description: '宿舍日光灯完全不亮，可能是镇流器故障',
          reporter: '陈华',
          dorm: '4号楼-201',
          time: '2023-10-16 10:20',
          type: '电器故障',
          urgency: '一般',
          status: 'pending'
        },
        {
          id: 4,
          title: '1号楼305宿舍窗户损坏',
          description: '窗户玻璃破裂，存在安全隐患',
          reporter: '刘伟',
          dorm: '1号楼-305',
          time: '2023-10-16 08:45',
          type: '家具损坏',
          urgency: '紧急',
          status: 'pending'
        }
      ],
      processing: [
        {
          id: 5,
          title: '1号楼306宿舍门锁损坏',
          description: '门锁无法正常使用，钥匙无法转动，需要更换锁芯',
          reporter: '李强',
          dorm: '1号楼-306',
          time: '2023-10-13 10:20',
          repairman: '王师傅',
          startTime: '2023-10-15 09:30',
          type: '家具损坏',
          status: 'processing'
        },
        {
          id: 6,
          title: '2号楼410宿舍网络故障',
          description: '宿舍网络连接不稳定，时断时续',
          reporter: '赵敏',
          dorm: '2号楼-410',
          time: '2023-10-14 15:40',
          repairman: '张师傅',
          startTime: '2023-10-16 14:00',
          type: '网络问题',
          status: 'processing'
        }
      ],
      completed: [
        {
          id: 7,
          title: '4号楼209宿舍灯管不亮',
          description: '宿舍主灯管闪烁后不亮，需要更换灯管',
          reporter: '刘芳',
          dorm: '4号楼-209',
          time: '2023-10-12 16:45',
          repairman: '张师傅',
          completeTime: '2023-10-12 16:45',
          type: '电器故障',
          status: 'completed',
          result: '已修复'
        },
        {
          id: 8,
          title: '3号楼112宿舍水管堵塞',
          description: '洗手池下水道堵塞，水无法排出',
          reporter: '孙浩',
          dorm: '3号楼-112',
          time: '2023-10-11 09:15',
          repairman: '李师傅',
          completeTime: '2023-10-11 11:30',
          type: '水管问题',
          status: 'completed',
          result: '已修复'
        },
        {
          id: 9,
          title: '5号楼308宿舍桌椅损坏',
          description: '书桌抽屉损坏无法使用，椅子腿松动',
          reporter: '周婷',
          dorm: '5号楼-308',
          time: '2023-10-10 14:20',
          repairman: '王师傅',
          completeTime: '2023-10-10 16:00',
          type: '家具损坏',
          status: 'completed',
          result: '已修复'
        }
      ]
    };

    // 初始化
    document.addEventListener('DOMContentLoaded', function () {
      updateStats();
      updateTabContent();
      setupEventListeners();
    });

    // 设置事件监听器
    function setupEventListeners() {
      // 搜索功能
      const searchInput = document.querySelector('.search-bar input');
      searchInput.addEventListener('input', function (e) {
        filterRepairs(e.target.value);
      });

      // 按钮事件
      document.getElementById('newRepairBtn').addEventListener('click', newRepair);
      document.getElementById('assignRepairBtn').addEventListener('click', assignRepair);
      document.getElementById('exportBtn').addEventListener('click', exportRepairData);
      document.getElementById('emergencyBtn').addEventListener('click', viewEmergency);
    }

    // 切换选项卡
    function switchTab(tabName) {
      currentTab = tabName;

      // 更新选项卡样式
      document.querySelectorAll('.repair-tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.dataset.tab === tabName) {
          tab.classList.add('active');
        }
      });

      updateTabContent();
    }

    // 更新标签页内容
    function updateTabContent() {
      const container = document.getElementById('repairList');
      let repairs = [];

      if (currentTab === 'all') {
        repairs = [...repairData.pending, ...repairData.processing, ...repairData.completed];
      } else {
        repairs = repairData[currentTab] || [];
      }

      container.innerHTML = '';

      if (repairs.length === 0) {
        container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-clipboard-list"></i>
                        <h3>暂无报修记录</h3>
                        <p>当前没有找到符合条件的报修记录</p>
                    </div>
                `;
        return;
      }

      repairs.forEach(repair => {
        const card = createRepairCard(repair);
        container.appendChild(card);
      });
    }

    // 创建报修卡片
    function createRepairCard(repair) {
      const card = document.createElement('div');
      card.className = 'repair-card';
      if (repair.urgency === '紧急' || repair.urgency === '特急') card.classList.add('emergency');
      if (repair.status === 'completed') card.classList.add('completed');

      let statusText = '';
      let statusClass = '';

      switch (repair.status) {
        case 'pending':
          statusText = repair.urgency === '紧急' || repair.urgency === '特急' ? '紧急' : '待处理';
          statusClass = 'status-pending';
          break;
        case 'processing':
          statusText = '处理中';
          statusClass = 'status-processing';
          break;
        case 'completed':
          statusText = '已完成';
          statusClass = 'status-completed';
          break;
      }

      card.innerHTML = `
                <div class="repair-header">
                    <div class="repair-title">${repair.title}</div>
                    <span class="status ${statusClass}">${statusText}</span>
                </div>
                <p>${repair.description}</p>
                <div class="repair-meta">
                    <span>报修人: ${repair.reporter}</span>
                    <span>宿舍: ${repair.dorm}</span>
                    ${repair.repairman ? `<span>维修员: ${repair.repairman}</span>` : ''}
                    <span>${repair.status === 'completed' ? '完成时间' : '提交时间'}: ${repair.status === 'completed' ? repair.completeTime : repair.time}</span>
                </div>
                <div class="repair-actions">
                    ${getActionButtons(repair)}
                </div>
            `;

      return card;
    }

    // 获取操作按钮
    function getActionButtons(repair) {
      switch (repair.status) {
        case 'pending':
          return `
                        <button class="btn btn-primary btn-sm" onclick="processRepair(${repair.id})">开始处理</button>
                        <button class="btn btn-warning btn-sm" onclick="assignToRepairman(${repair.id})">分配维修员</button>
                        <button class="btn btn-danger btn-sm" onclick="cancelRepairItem(${repair.id})">取消报修</button>
                    `;
        case 'processing':
          return `
                        <button class="btn btn-success btn-sm" onclick="completeRepair(${repair.id})">完成维修</button>
                        <button class="btn btn-warning btn-sm" onclick="updateProgress(${repair.id})">更新进度</button>
                    `;
        case 'completed':
          return `
                        <button class="btn btn-primary btn-sm" onclick="viewDetails(${repair.id})">查看详情</button>
                        <button class="btn btn-warning btn-sm" onclick="addComment(${repair.id})">添加备注</button>
                    `;
        default:
          return '';
      }
    }

    // 更新统计
    function updateStats() {
      const pendingCount = repairData.pending.length;
      const emergencyCount = repairData.pending.filter(r => r.urgency === '紧急' || r.urgency === '特急').length;
      const processingCount = repairData.processing.length;
      const completedCount = repairData.completed.length;

      document.getElementById('pendingCount').textContent = pendingCount;
      document.getElementById('emergencyCount').textContent = emergencyCount;
      document.getElementById('processingCount').textContent = processingCount;
      document.getElementById('completedCount').textContent = completedCount;

      document.getElementById('pendingTabCount').textContent = pendingCount;
      document.getElementById('processingTabCount').textContent = processingCount;
      document.getElementById('completedTabCount').textContent = completedCount;
    }

    // 新建报修
    function newRepair() {
      showModal('新建报修申请', `
                <form id="newRepairFormModal">
                    <div class="form-row">
                        <div class="form-group">
                            <label>报修人 *</label>
                            <input type="text" class="form-control" id="reporterName" placeholder="请输入姓名" required>
                        </div>
                        <div class="form-group">
                            <label>联系方式 *</label>
                            <input type="tel" class="form-control" id="reporterPhone" placeholder="请输入电话" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>宿舍位置 *</label>
                            <select class="form-control" id="dormLocation" required>
                                <option value="">请选择宿舍</option>
                                <option value="1号楼-101">1号楼-101</option>
                                <option value="1号楼-305">1号楼-305</option>
                                <option value="2号楼-410">2号楼-410</option>
                                <option value="2号楼-512">2号楼-512</option>
                                <option value="3号楼-112">3号楼-112</option>
                                <option value="3号楼-408">3号楼-408</option>
                                <option value="4号楼-201">4号楼-201</option>
                                <option value="4号楼-209">4号楼-209</option>
                                <option value="5号楼-308">5号楼-308</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>报修类型 *</label>
                            <select class="form-control" id="repairType" required>
                                <option value="">请选择</option>
                                <option value="电器故障">电器故障</option>
                                <option value="水管问题">水管问题</option>
                                <option value="家具损坏">家具损坏</option>
                                <option value="网络问题">网络问题</option>
                                <option value="门窗问题">门窗问题</option>
                                <option value="其他">其他</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>问题描述 *</label>
                        <textarea class="form-control" id="problemDesc" rows="3" placeholder="请详细描述问题..." required></textarea>
                    </div>
                    <div class="form-group">
                        <label>紧急程度</label>
                        <div style="display: flex; gap: 15px; margin-top: 8px;">
                            <label><input type="radio" name="urgency" value="一般" checked> 一般</label>
                            <label><input type="radio" name="urgency" value="紧急"> 紧急</label>
                            <label><input type="radio" name="urgency" value="特急"> 特急</label>
                        </div>
                    </div>
                </form>
            `, function () {
        const form = document.getElementById('newRepairFormModal');
        if (form.checkValidity()) {
          const dormLocation = document.getElementById('dormLocation').value;
          const repairType = document.getElementById('repairType').value;

          const newRepair = {
            id: Date.now(),
            title: dormLocation + ' ' + repairType,
            description: document.getElementById('problemDesc').value,
            reporter: document.getElementById('reporterName').value,
            dorm: dormLocation,
            time: new Date().toLocaleString('zh-CN'),
            type: repairType,
            urgency: document.querySelector('input[name="urgency"]:checked').value,
            status: 'pending'
          };

          repairData.pending.push(newRepair);
          updateTabContent();
          updateStats();
          alert('报修申请已提交！');
          return true;
        } else {
          form.reportValidity();
          return false;
        }
      });
    }

    // 处理报修
    function processRepair(id) {
      showModal('开始处理报修', `
                <div class="form-group">
                    <label>指派维修员 *</label>
                    <select class="form-control" id="assignRepairman" required>
                        <option value="">请选择维修员</option>
                        <option value="王师傅">王师傅</option>
                        <option value="张师傅">张师傅</option>
                        <option value="李师傅">李师傅</option>
                        <option value="赵师傅">赵师傅</option>
                        <option value="刘师傅">刘师傅</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>预计完成时间</label>
                    <input type="datetime-local" class="form-control" id="estimatedTime">
                </div>
                <div class="form-group">
                    <label>备注</label>
                    <textarea class="form-control" id="processNote" rows="2" placeholder="可填写处理注意事项..."></textarea>
                </div>
            `, function () {
        const repairman = document.getElementById('assignRepairman').value;
        if (!repairman) {
          alert('请选择维修员！');
          return false;
        }

        const repairIndex = repairData.pending.findIndex(r => r.id === id);
        if (repairIndex !== -1) {
          const repair = repairData.pending[repairIndex];
          repair.repairman = repairman;
          repair.status = 'processing';
          repair.startTime = new Date().toLocaleString('zh-CN');

          repairData.processing.push(repair);
          repairData.pending.splice(repairIndex, 1);

          updateTabContent();
          updateStats();
          alert('已开始处理该报修！');
          return true;
        }
        return false;
      });
    }

    // 分配维修员（批量）
    function assignRepair() {
      showModal('批量分配维修员', `
                <div class="form-group">
                    <label>选择维修员 *</label>
                    <select class="form-control" id="batchRepairman" required>
                        <option value="">请选择维修员</option>
                        <option value="王师傅">王师傅</option>
                        <option value="张师傅">张师傅</option>
                        <option value="李师傅">李师傅</option>
                        <option value="赵师傅">赵师傅</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>选择要分配的报修（按住Ctrl多选） *</label>
                    <select class="form-control" id="selectRepairs" multiple style="height: 120px;">
                        ${repairData.pending.map(r => `<option value="${r.id}">${r.dorm} - ${r.title}</option>`).join('')}
                    </select>
                </div>
            `, function () {
        const repairman = document.getElementById('batchRepairman').value;
        const selectedOptions = document.getElementById('selectRepairs').selectedOptions;

        if (!repairman || selectedOptions.length === 0) {
          alert('请选择维修员和至少一个报修！');
          return false;
        }

        const selectedIds = Array.from(selectedOptions).map(opt => parseInt(opt.value));

        selectedIds.forEach(id => {
          const repairIndex = repairData.pending.findIndex(r => r.id === id);
          if (repairIndex !== -1) {
            const repair = repairData.pending[repairIndex];
            repair.repairman = repairman;
            repair.status = 'processing';
            repair.startTime = new Date().toLocaleString('zh-CN');

            repairData.processing.push(repair);
            repairData.pending.splice(repairIndex, 1);
          }
        });

        updateTabContent();
        updateStats();
        alert(`已成功分配${selectedIds.length}个报修给${repairman}！`);
        return true;
      });
    }

    // 完成维修
    function completeRepair(id) {
      showModal('完成维修', `
                <div class="form-group">
                    <label>维修结果 *</label>
                    <select class="form-control" id="repairResult" required>
                        <option value="已修复">已修复</option>
                        <option value="需更换配件">需更换配件</option>
                        <option value="无法修复">无法修复</option>
                        <option value="其他原因">其他原因</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>材料费用（元）</label>
                    <input type="number" class="form-control" id="materialCost" value="0" step="0.01" min="0">
                </div>
                <div class="form-group">
                    <label>维修说明</label>
                    <textarea class="form-control" id="completeNote" rows="3" placeholder="请填写维修说明..."></textarea>
                </div>
            `, function () {
        const repairIndex = repairData.processing.findIndex(r => r.id === id);
        if (repairIndex !== -1) {
          const repair = repairData.processing[repairIndex];
          repair.status = 'completed';
          repair.completeTime = new Date().toLocaleString('zh-CN');
          repair.result = document.getElementById('repairResult').value;
          repair.cost = document.getElementById('materialCost').value;
          repair.note = document.getElementById('completeNote').value;

          repairData.completed.push(repair);
          repairData.processing.splice(repairIndex, 1);

          updateTabContent();
          updateStats();
          alert('维修完成！');
          return true;
        }
        return false;
      });
    }

    // 取消报修
    function cancelRepairItem(id) {
      if (confirm('确定要取消这个报修申请吗？')) {
        const pendingIndex = repairData.pending.findIndex(r => r.id === id);
        if (pendingIndex !== -1) {
          repairData.pending.splice(pendingIndex, 1);
          updateTabContent();
          updateStats();
          alert('报修已取消！');
        }
      }
    }

    // 查看详情
    function viewDetails(id) {
      let repair = [...repairData.pending, ...repairData.processing, ...repairData.completed].find(r => r.id === id);

      if (repair) {
        showModal('报修详情', `
                    <div class="repair-detail">
                        <h4>${repair.title}</h4>
                        <div class="detail-info">
                            <p><strong>报修人:</strong> ${repair.reporter}</p>
                            <p><strong>宿舍位置:</strong> ${repair.dorm}</p>
                            <p><strong>报修类型:</strong> ${repair.type}</p>
                            <p><strong>紧急程度:</strong> ${repair.urgency || '一般'}</p>
                            <p><strong>提交时间:</strong> ${repair.time}</p>
                            ${repair.repairman ? `<p><strong>维修员:</strong> ${repair.repairman}</p>` : ''}
                            ${repair.startTime ? `<p><strong>开始时间:</strong> ${repair.startTime}</p>` : ''}
                            ${repair.completeTime ? `<p><strong>完成时间:</strong> ${repair.completeTime}</p>` : ''}
                            ${repair.result ? `<p><strong>维修结果:</strong> ${repair.result}</p>` : ''}
                            ${repair.cost ? `<p><strong>材料费用:</strong> ${repair.cost}元</p>` : ''}
                        </div>
                        <div class="detail-desc">
                            <h5>问题描述:</h5>
                            <p>${repair.description}</p>
                        </div>
                        ${repair.note ? `
                        <div class="detail-note">
                            <h5>维修说明:</h5>
                            <p>${repair.note}</p>
                        </div>
                        ` : ''}
                    </div>
                `, null, false);
      }
    }

    // 过滤报修
    function filterRepairs(keyword) {
      const allRepairs = [...repairData.pending, ...repairData.processing, ...repairData.completed];
      const filtered = allRepairs.filter(repair =>
        repair.title.includes(keyword) ||
        repair.description.includes(keyword) ||
        repair.reporter.includes(keyword) ||
        repair.dorm.includes(keyword) ||
        repair.type.includes(keyword)
      );

      const container = document.getElementById('repairList');
      container.innerHTML = '';

      if (filtered.length === 0) {
        container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-search"></i>
                        <h3>未找到相关报修</h3>
                        <p>请尝试其他搜索关键词</p>
                    </div>
                `;
        return;
      }

      filtered.forEach(repair => {
        const card = createRepairCard(repair);
        container.appendChild(card);
      });
    }

    // 导出记录
    function exportRepairData() {
      const dataStr = JSON.stringify(repairData, null, 2);
      const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);

      const exportFileDefaultName = `报修记录_${new Date().toISOString().split('T')[0]}.json`;

      const linkElement = document.createElement('a');
      linkElement.setAttribute('href', dataUri);
      linkElement.setAttribute('download', exportFileDefaultName);
      linkElement.click();

      alert('报修记录已导出为JSON文件！');
    }

    // 查看紧急报修
    function viewEmergency() {
      const emergencyRepairs = repairData.pending.filter(r => r.urgency === '紧急' || r.urgency === '特急');

      if (emergencyRepairs.length === 0) {
        alert('当前没有紧急报修！');
        return;
      }

      showModal('紧急报修列表', `
                <div class="emergency-list">
                    ${emergencyRepairs.map(r => `
                        <div class="emergency-item" style="margin-bottom: 15px; padding: 10px; border-left: 3px solid #e74c3c; background: #fff9f9;">
                            <h5 style="color: #e74c3c;">${r.title}</h5>
                            <p><strong>宿舍:</strong> ${r.dorm}</p>
                            <p><strong>报修人:</strong> ${r.reporter}</p>
                            <p><strong>时间:</strong> ${r.time}</p>
                            <button class="btn btn-primary btn-sm" onclick="closeModal(); processRepair(${r.id})" style="margin-top: 5px;">立即处理</button>
                        </div>
                    `).join('')}
                </div>
            `, null, false);
    }

    // 显示模态框
    function showModal(title, content, onConfirm, showConfirm = true) {
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.id = 'customModal';

      modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>${title}</h3>
                        <button class="close-btn" onclick="closeModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        ${content}
                    </div>
                    ${showConfirm ? `
                        <div class="modal-footer" style="margin-top: 20px; text-align: right;">
                            <button class="btn btn-warning" onclick="closeModal()">取消</button>
                            <button class="btn btn-primary" onclick="confirmModal()" style="margin-left: 10px;">确定</button>
                        </div>
                    ` : ''}
                </div>
            `;

      document.body.appendChild(modal);
      modal.style.display = 'flex';

      // 存储回调函数
      modal._onConfirm = onConfirm;

      // 添加ESC键关闭功能
      document.addEventListener('keydown', function escHandler(e) {
        if (e.key === 'Escape') {
          closeModal();
          document.removeEventListener('keydown', escHandler);
        }
      });
    }

    // 关闭模态框
    function closeModal() {
      const modal = document.getElementById('customModal');
      if (modal) {
        document.body.removeChild(modal);
      }
    }

    // 确认模态框操作
    function confirmModal() {
      const modal = document.getElementById('customModal');
      if (modal._onConfirm) {
        const result = modal._onConfirm();
        if (result) {
          closeModal();
        }
      } else {
        closeModal();
      }
    }

    // 以下为辅助功能函数
    function assignToRepairman(id) {
      processRepair(id);
    }

    function addComment(id) {
      showModal('添加备注', `
                <div class="form-group">
                    <label>备注内容</label>
                    <textarea class="form-control" id="commentText" rows="3" placeholder="请输入备注内容..." required></textarea>
                </div>
            `, function () {
        const comment = document.getElementById('commentText').value;
        if (comment.trim()) {
          alert('备注已添加！');
          return true;
        }
        return false;
      });
    }

    function updateProgress(id) {
      showModal('更新维修进度', `
                <div class="form-group">
                    <label>当前进度</label>
                    <select class="form-control" id="progressStatus">
                        <option value="已到场检查">已到场检查</option>
                        <option value="等待配件">等待配件</option>
                        <option value="维修中">维修中</option>
                        <option value="已完成测试">已完成测试</option>
                        <option value="待验收">待验收</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>进度说明</label>
                    <textarea class="form-control" id="progressNote" rows="3" placeholder="请填写进度说明..."></textarea>
                </div>
            `, function () {
        const progress = document.getElementById('progressStatus').value;
        alert(`进度已更新为: ${progress}`);
        return true;
      });
    }
  </script>
</body>

</html>